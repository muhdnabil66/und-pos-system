<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UND PERFORMANCE - MAIN TERMINAL</title>
    <style>
        :root {
            --win-grey: #d4d0c8;
            --win-blue: #000080;
            --win-border-light: #ffffff;
            --win-border-dark: #808080;
        }

        body {
            background-color: #008080;
            font-family: "MS Sans Serif", "Arial", sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #serviceOverlay, #customModal, #drinkModal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #drinkModal, #serviceOverlay { display: none; }

        /* Responsive Sidebar Logic */
        #sidebar {
            width: 220px;
            background-color: var(--win-grey);
            border-right: 2px solid var(--win-border-dark);
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-shadow: inset -1px -1px 0 #000;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 9999;
        }

        #hamburger-toggle {
            display: none;
            background: var(--win-grey);
            border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            padding: 5px 10px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }

        @media (max-width: 1024px) {
            #sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #hamburger-toggle {
                display: block;
            }
        }

        .profile-card {
            background: #fff;
            border: 2px solid;
            border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark);
            padding: 10px;
            margin-bottom: 20px;
            font-size: 11px;
        }

        .profile-card h3 {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: var(--win-blue);
            border-bottom: 1px solid var(--win-border-dark);
        }

        .nav-button {
            background: var(--win-grey);
            border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            padding: 8px;
            margin-bottom: 5px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            display: block;
            width: 100%;
        }

        .nav-button:active, .sub-filter-btn.active {
            border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark);
            background: #e6e6e6;
        }

        #main-terminal {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            min-width: 0;
        }

        .window-frame {
            background-color: var(--win-grey);
            border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .title-bar {
            background-color: var(--win-blue);
            color: white;
            padding: 4px 10px;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .content-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .menu-side {
            flex: 1;
            overflow-y: scroll;
            background: #808080;
            padding: 15px;
            scroll-behavior: smooth;
        }

        .category-header {
            background: #404040;
            color: #fff;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
            margin: 10px 0;
            border: 1px solid #000;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .food-item {
            background: var(--win-grey);
            border: 2px solid;
            border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }

        .food-item.unavailable {
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .food-item img {
            width: 100%;
            height: 80px;
            object-fit: contain;
            background: #fff;
            border: 1px solid #000;
            margin-bottom: 5px;
        }

        .win-table {
            width: 100%;
            background: #fff;
            border-collapse: collapse;
            font-size: 12px;
        }
        .win-table th { background: var(--win-blue); color: #fff; padding: 5px; text-align: left; }
        .win-table td { border: 1px solid #808080; padding: 5px; }
        
        #order-summary {
            width: 300px;
            background: var(--win-grey);
            border-left: 2px solid var(--win-border-dark);
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            #order-summary { width: 200px; }
        }

        #cart-items {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            border: 2px solid;
            border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .cart-row {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px dotted #ccc;
            align-items: center;
        }

        .total-box {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: "Courier New", monospace;
            font-size: 20px;
            font-weight: bold; text-align: right; border: 2px solid var(--win-border-dark); 
        } 
        
        .modal-box { background: var(--win-grey); border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); width: 300px; padding: 2px; } 
        
        .status-bar { background: var(--win-grey); border-top: 2px solid var(--win-border-dark); padding: 3px 10px; font-size: 11px; display: flex; justify-content: space-between; flex-shrink: 0; } 
        
        .restricted-locked { filter: grayscale(1); } 
        .logout-unlocked { pointer-events: auto !important; filter: none !important; } 
        
        .sub-filter-btn { background: var(--win-grey); border: 2px solid; border-color: var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); padding: 2px 8px; margin-right: 4px; cursor: pointer; font-size: 11px; font-weight: bold; } 
        
        .search-container { position: relative; margin-left: 10px; display: inline-block; } 
        #searchInput { border: 2px solid; border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark); padding: 3px; width: 200px; font-family: "MS Sans Serif"; } 
        #searchDropdown { position: absolute; top: 100%; left: 0; width: 250px; background: #fff; border: 1px solid #000; z-index: 999; display: none; max-height: 300px; overflow-y: auto; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); } 
        .search-item { display: flex; align-items: center; padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; } 
        .search-item:hover { background: #000080; color: #fff; } 
        .search-item img { width: 30px; height: 30px; margin-right: 10px; border: 1px solid #ccc; background: #fff; } 
        .best-seller-tag { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 9px; padding: 2px 4px; border: 1px solid black; z-index: 5; } 
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 20px; } 
        .stat-card { background: #fff; border: 1px solid #808080; padding: 5px; text-align: center; box-shadow: 1px 1px 0 #000; font-size: 10px; } 
        .stat-card b { display: block; height: 2.4em; overflow: hidden; } 
        .stat-card span { font-size: 14px !important; } 
        .history-box { width: 120px; height: 80px; background: #fff; border: 2px solid var(--win-border-dark); display: inline-block; margin: 5px; padding: 5px; cursor: pointer; font-size: 10px; vertical-align: top; } 
        .history-box:hover { border-color: var(--win-blue); } 
        #modalButtons { display: flex; gap: 10px; justify-content: center; padding-bottom: 10px; flex-wrap: wrap; } 
        #modalButtons .nav-button { width: auto; min-width: 80px; margin: 0; padding: 5px 15px; } 
        .progress-container { border: 2px solid; border-color: var(--win-border-dark) var(--win-border-light) var(--win-border-light) var(--win-border-dark); background: #fff; height: 25px; display: flex; padding: 2px; margin: 10px 0; } 
        .progress-segment { background: var(--win-blue); width: 10%; height: 100%; margin-right: 2px; } 
    </style>
</head>
<body onload="initMenu()">

    <div id="customModal" style="display:none;">
        <div class="modal-box" style="width: 450px; max-width: 90%;">
            <div class="title-bar"><span id="modalTitle">SYSTEM_MESSAGE.EXE</span></div>
            <div style="padding: 20px; background: var(--win-grey); text-align: center;">
                <div id="modalContent">
                    <p id="modalText" style="font-size: 12px; margin-bottom: 20px; white-space: pre-line;">Message content here.</p>
                </div>
                <div id="modalButtons"></div>
            </div>
        </div>
    </div>

    <div id="serviceOverlay" style="display: flex;">
        <div class="modal-box" style="width: 450px; max-width: 90%;">
            <div class="title-bar"><span>SYSTEM_INITIALIZATION.EXE</span></div>
            <div style="padding: 20px; text-align: center;">
                <h2 style="margin-top: 0; font-size: 18px;">SELECT SERVICE TYPE</h2>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button class="nav-button" style="flex: 1; height: 120px; font-size: 14px;" onclick="selectService('DINE IN')">üçΩÔ∏è<br>DINE IN</button>
                    <button class="nav-button" style="flex: 1; height: 120px; font-size: 14px;" onclick="selectService('TAKE AWAY')">ü•°<br>TAKE AWAY</button>
                </div>
                <button class="nav-button" style="background: #808080; color: white;" onclick="selectService('NOT SET')">CLOSE (NOT SET)</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <h3>EMPLOYEE PROFILE</h3>
            <div id="prof-name"><b>NAME:</b> ...</div>
            <div id="prof-id"><b>ID:</b> ...</div>
            <div id="prof-code"><b>CODE:</b> ...</div>
            <div id="prof-store"><b>STORE:</b> PNG-MAIN-HUB</div>
            <div id="prof-shift"><b>SHIFT:</b> ...</div>
            <div id="service-type" style="margin-top: 5px; color: #d00; font-weight: bold;">TYPE: NOT SET</div>
        </div>
        <div id="nav-container">
            <button class="nav-button" onclick="switchView('MENU')"> NEW ORDER</button>
            <button class="nav-button" onclick="switchView('TRANSACTIONS')"> TRANSACTIONS</button>
            <button class="nav-button" onclick="switchView('INVENTORY')"> INVENTORY</button>
            <button class="nav-button" onclick="switchView('ITEMS')"> EDIT ITEMS</button>
            <button class="nav-button" onclick="switchView('SALES')"> SALES REPORT</button>
            <button class="nav-button" onclick="switchView('SETTINGS')"> SETTINGS</button>
        </div>
        <button class="nav-button logout-unlocked" style="margin-top: auto; background: #c00; color: white;" onclick="triggerLogout()">üîì LOGOUT</button>
    </div>

    <div id="main-terminal">
        <div id="main-frame-wrapper" class="window-frame">
            <div class="title-bar">
                <div style="display: flex; align-items: center;">
                    <button id="hamburger-toggle" onclick="toggleSidebar()">‚ò∞ START</button>
                    <span id="win-title">POS_MENU_EXPLORER.EXE</span>
                </div>
                <span id="top-clock">00:00:00</span>
            </div>
            
            <div id="toolbar" style="padding: 10px; background: var(--win-grey); border-bottom: 1px solid #808080; font-size: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <b>Category:</b> 
                            <select id="categorySelect" onchange="renderMenu()" style="margin-left:5px;">
                                <option value="ALL">ALL PRODUCTS</option>
                                <option value="FOOD">FOOD</option>
                                <option value="DRINKS">DRINKS</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>

                        <div class="search-container">
                            <b>Search:</b>
                            <input type="text" id="searchInput" placeholder="Find item..." oninput="handleSearch()">
                            <div id="searchDropdown"></div>
                        </div>
                    </div>
                    
                    <button class="nav-button" style="width: auto; margin: 0; padding: 2px 10px; background: #d4d0c8;" onclick="triggerReboot()">üîÑ REBOOT</button>
                </div>
                <div id="subFilters" style="overflow-x: auto; white-space: nowrap; padding-bottom: 5px;">
                    <button class="sub-filter-btn active" onclick="setSubFilter('ALL', this)">ALL</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Nasi', this)">NASI</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Mee', this)">MEE</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Ayam', this)">AYAM</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Daging', this)">DAGING</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Sotong', this)">SOTONG</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Udang', this)">UDANG</button>
                    <button class="sub-filter-btn" onclick="setSubFilter('Perut', this)">OTHER</button>
                </div>
            </div>

            <div class="content-body">
                <div class="menu-side" id="menuContainer"></div>

                <div id="order-summary">
                    <div class="profile-card" style="margin-bottom:10px; text-align:center; font-weight:bold;">CURRENT RECEIPT</div>
                    <div id="cart-items"></div>
                    <div class="total-box">
                        RM <span id="cart-total">0.00</span>
                    </div>
                    <button class="nav-button" id="pay-btn" style="background:#008000; color:white; margin-top:10px;" onclick="proceedToPayment()">PAY >></button>
                </div>
            </div>

            <div class="status-bar">
                <span id="status-date">DATE: --/--/----</span>
                <span id="status-node">NODE: PNG-24 ACTIVE</span>
                <span id="status-user">USER: Unknown</span>
            </div>
        </div>
    </div>

    <div id="drinkModal">
        <div class="modal-box">
            <div class="title-bar"><span>SELECT TEMPERATURE</span></div>
            <div style="text-align:center; padding:10px;">
                <img id="drinkModalImg" src="undpfm.png" style="width:50px; height:50px; background:#fff; border:1px solid #000;">
                <div id="modalItemName" style="font-weight:bold; margin-top:5px;">ITEM</div>
            </div>
            <div class="option-container" style="display:flex; gap:10px; padding:15px;">
                <div class="temp-option" style="flex:1; background:var(--win-grey); border:2px solid; border-color:var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); padding:10px; cursor:pointer; text-align: center;" onclick="confirmDrink('HOT')">‚ô®Ô∏è HOT<br>(Base)</div>
                <div class="temp-option" style="flex:1; background:var(--win-grey); border:2px solid; border-color:var(--win-border-light) var(--win-border-dark) var(--win-border-dark) var(--win-border-light); padding:10px; cursor:pointer; text-align: center;" onclick="confirmDrink('COLD')">‚ùÑÔ∏è COLD<br>(+0.50)</div>
            </div>
            <div style="text-align:center; padding-bottom:10px;">
                <button class="nav-button" style="width:80%; margin: 0 auto;" onclick="closeDrinkModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        const defaultMenuData = [
            { cat: "FOOD", name: "Nasi Putih", img: "nasi.png", price: 1.50, stock: 50, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Biasa", img: "nasi_goreng_biasa.png", price: 6.00, stock: 30, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Kampung", img: "nasi_goreng_kampung.png", price: 9.00, stock: 25, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Ayam", img: "nasi_goreng_ayam.png", price: 8.50, stock: 20, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Cina", img: "nasi_goreng_cina.png", price: 9.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Tomyam", img: "nasi_goreng_tomyam.png", price: 10.00, bestSeller: true, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng USA", img: "nasi_goreng_usa.png", price: 10.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Pattaya", img: "nasi_goreng_pattaya.png", price: 10.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Daging", img: "nasi_goreng_daging.png", price: 10.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Ayam Kunyit", img: "nasi_goreng_ayam_kunyit.png", price: 9.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Goreng Ladna", img: "nasi_goreng_ladna.png", price: 10.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Maggi Goreng", img: "maggi_goreng.png", price: 5.00, stock: 40, hidden: false },
            { cat: "FOOD", name: "Mee Goreng", img: "mee_goreng.png", price: 6.50, stock: 30, hidden: false },
            { cat: "FOOD", name: "Tomyam Ayam", img: "tomyam_ayam.png", price: 10.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Tomyam Daging", img: "tomyam_daging.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Tomyam Seafood", img: "tomyam_seafood.png", price: 15.00, bestSeller: true, stock: 10, hidden: false },
            { cat: "FOOD", name: "Tomyam Campur", img: "tomyam_campur.png", price: 12.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Tomyam Goong", img: "tomyam_goong.png", price: 18.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Tomyam Poktek", img: "tomyam_poktek.png", price: 15.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Tomyam Putih", img: "tomyam_putih.png", price: 12.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Sup Gearbox", img: "sup_gearbox.png", price: 10.00, stock: 5, hidden: false },
            { cat: "FOOD", name: "Sup Tulang", img: "sup_tulang.png", price: 9.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Sup Perut", img: "sup_perut.png", price: 9.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Ayam Paprik", img: "ayam_paprik.png", price: 9.50, bestSeller: true, stock: 20, hidden: false },
            { cat: "FOOD", name: "Ayam 3 Rasa", img: "ayam_3_rasa.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Ayam Masak Merah", img: "ayam_masak_merah.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Ayam Goreng Kunyit", img: "ayam_goreng_kunyit.png", price: 9.50, stock: 20, hidden: false },
            { cat: "FOOD", name: "Ayam Masak Halia", img: "ayam_masak_halia.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Ayam Masak Kicap", img: "ayam_masak_kicap.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Daging Masak Merah", img: "daging_masak_merah.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Daging Paprik", img: "daging_paprik.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Daging Goreng Kunyit", img: "daging_goreng_kunyit.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Daging Masak Black Pepper", img: "daging_black_pepper.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Daging Masak Pedas", img: "daging_masak_pedas.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Perut Goreng Kunyit", img: "perut_goreng_kunyit.png", price: 10.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Perut Masak Hitam", img: "perut_masak_hitam.png", price: 10.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Udang 3 Rasa", img: "udang_3_rasa.png", price: 14.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Udang Butter", img: "udang_butter.png", price: 14.00, bestSeller: true, stock: 10, hidden: false },
            { cat: "FOOD", name: "Udang Goreng Kunyit", img: "udang_goreng_kunyit.png", price: 14.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Sotong Goreng Kunyit", img: "sotong_goreng_kunyit.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Sotong Tepung", img: "sotong_tepung.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Sotong Sambal", img: "sotong_sambal.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Sotong Masak Merah", img: "sotong_masak_pedas.png", price: 12.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Ikan 3 Rasa", img: "ikan_3_rasa.png", price: 20.00, stock: 5, hidden: false },
            { cat: "FOOD", name: "Sayur Campur", img: "sayur_campur.png", price: 6.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Sayur Kailan", img: "sayur_kailan.png", price: 7.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Kobis Goreng", img: "kobis_goreng.png", price: 6.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Telur Dadar", img: "telur_dadar.png", price: 3.00, stock: 50, hidden: false },
            { cat: "FOOD", name: "Telur Mata", img: "telur_mata.png", price: 2.00, stock: 50, hidden: false },
            { cat: "FOOD", name: "Telur Bungkus", img: "telur_bungkus.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Telur Bistik", img: "telur_bistik.png", price: 9.50, stock: 15, hidden: false },
            { cat: "FOOD", name: "Bihun Tomyam", img: "bihun_tomyam.png", price: 9.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Kuey Teow Tomyam", img: "kuey_teow_tomyam.png", price: 9.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Maggi Tomyam", img: "maggi_tomyam.png", price: 9.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Wat Tan Hor", img: "wat_tan_hor.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Char Kuey Teow", img: "char_kuey_teow.png", price: 11.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Nasi Putih Lauk Set", img: "nasi_lauk_set.png", price: 12.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Chicken Chop", img: "chicken_chop.png", price: 15.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Lamb Chop", img: "lamb_chop.png", price: 22.00, stock: 10, hidden: false },
            { cat: "FOOD", name: "Spaghetti Aglio Olio", img: "spaghetti_aglio.png", price: 9.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Spaghetti Carbonara", img: "spaghetti_carbonara.png", price: 13.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Spaghetti Bolognese", img: "spaghetti_bolognese.png", price: 12.00, stock: 15, hidden: false },
            { cat: "FOOD", name: "Roti Canai", img: "roti_canai.png", price: 1.50, stock: 100, hidden: false },
            { cat: "FOOD", name: "Roti Telur", img: "roti_telur.png", price: 3.00, stock: 50, hidden: false },
            { cat: "FOOD", name: "Cheesy Wedges", img: "cheesy_wedges.png", price: 8.00, stock: 20, hidden: false },
            { cat: "FOOD", name: "Ayam Goreng Berempah", img: "ayam_berempah.png", price: 4.00, stock: 40, hidden: false },
            { cat: "FOOD", name: "Keropok Lekor", img: "lekor.png", price: 7.00, stock: 40, hidden: false },
            { cat: "FOOD", name: "Otak-otak", img: "otak_otak.png", price: 1.00, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Teh", img: "teh.png", price: 2.50, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Kopi", img: "kopi.png", price: 2.50, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Milo", img: "milo.png", price: 3.50, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Sirap", img: "sirap.png", price: 2.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Sirap Limau", img: "sirap_limau.png", price: 2.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Teh O", img: "teh_o.png", price: 2.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Kopi O", img: "kopi_o.png", price: 2.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Nescafe", img: "nescafe.png", price: 3.50, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Neslo", img: "neslo.png", price: 4.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Barli", img: "barli.png", price: 3.00, hasTemp: true, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Teh Tarik", img: "teh_tari.png", price: 2.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Matcha", img: "matcha.png", price: 6.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Ais Kepal Milo", img: "ais_kepal_milo.png", price: 5.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "ABC", img: "abc.png", price: 6.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "BingXue", img: "bingxue.png", price: 5.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Air Mineral", img: "mineral.png", price: 1.50, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Jus Tembikai", img: "jus_tembikai.png", price: 5.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Sky Juice", img: "sky_juice.png", price: 0.50, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Extra Joss Anggur", img: "anggur.png", price: 3.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Extra Joss Mangga", img: "mangga.png", price: 3.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Extra Joss Oren", img: "oren.png", price: 3.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "DRINKS", name: "Extra Joss Original", img: "original.png", price: 3.00, hasTemp: false, stock: 100, hidden: false },
            { cat: "OTHER", name: "Plastic Bag", img: "undpfm.png", price: 0.20, stock: 1000, hidden: false }
        ];

        let menuData = JSON.parse(localStorage.getItem("pos_inventory_db")) || defaultMenuData;
        let cart = [];
        let pendingItem = null;
        let selectedServiceStr = "NOT SET";
        let transactionHistory = JSON.parse(localStorage.getItem("pos_history")) || [];
        let archivedSales = JSON.parse(localStorage.getItem("pos_archived_sales")) || [];
        let activeSubFilter = "ALL";
        let isSystemRestricted = false;
        let userProfile = null;

        function saveDatabase() {
            localStorage.setItem("pos_inventory_db", JSON.stringify(menuData));
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function initMenu() {
            userProfile = JSON.parse(localStorage.getItem("loggedInUser"));
            if (!userProfile) { window.location.href = "index.html"; return; }
            
            document.getElementById('prof-name').innerHTML = `<b>NAME:</b> ${userProfile.name}`;
            document.getElementById('prof-id').innerHTML = `<b>ID:</b> ${userProfile.undid}`;
            document.getElementById('prof-code').innerHTML = `<b>CODE:</b> ${userProfile.code}`;
            document.getElementById('prof-shift').innerHTML = `<b>SHIFT:</b> ${userProfile.shift}`;
            document.getElementById('status-user').innerText = `USER: ${userProfile.loginId.toUpperCase()}`;
           
            checkMidnightReset();

            if (userProfile.loginId === "demo") {
                isSystemRestricted = true;
                applyRestrictionUI();
                triggerRestrictedPopup("DEMO MODE: Terminal is currently locked for this account.");
            } else if (userProfile.loginId !== "manager01") {
                checkShiftLock(userProfile.shift);
            } else {
                if(selectedServiceStr === "NOT SET") {
                    document.getElementById('serviceOverlay').style.display = 'flex';
                }
            }

            switchView('MENU');
            updateClock();
        }

        function checkMidnightReset() {
            const todayStr = new Date().toDateString();
            const lastLog = localStorage.getItem("pos_last_date");

            if (lastLog && lastLog !== todayStr) {
                const daySummary = calculateDaySales();
                if (daySummary.total > 0) {
                    archivedSales.push({
                        date: lastLog,
                        total: daySummary.total,
                        items: daySummary.items,
                        transactions: [...transactionHistory]
                    });
                    localStorage.setItem("pos_archived_sales", JSON.stringify(archivedSales));
                }
                transactionHistory = [];
                localStorage.setItem("pos_history", JSON.stringify([]));
            }
            localStorage.setItem("pos_last_date", todayStr);
        }

        function calculateDaySales() {
            let total = 0;
            let items = {};
            transactionHistory.forEach(t => {
                total += parseFloat(t.amount);
                if(t.cart) {
                    t.cart.forEach(c => {
                        let cleanName = c.name.split(" [")[0].replace(" (T/A)", "");
                        items[cleanName] = (items[cleanName] || 0) + 1;
                    });
                }
            });
            return { total, items };
        }

        function checkShiftLock(shiftStr) {
            const timePart = shiftStr.match(/(\d{2}:\d{2})‚Äì(\d{2}:\d{2})/);
            if (!timePart) return;
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startH, startM] = timePart[1].split(':').map(Number);
            const [endH, endM] = timePart[2].split(':').map(Number);
            let startTime = startH * 60 + startM;
            let endTime = endH * 60 + endM;
            let isAllowed = startTime < endTime ? (currentTime >= startTime && currentTime <= endTime) : (currentTime >= startTime || currentTime <= endTime);
            if (!isAllowed) {
                isSystemRestricted = true;
                applyRestrictionUI();
                triggerRestrictedPopup();
            } else {
                isSystemRestricted = false;
                document.getElementById('serviceOverlay').style.display = 'flex';
            }
        }

        function applyRestrictionUI() {
            document.getElementById('main-frame-wrapper').classList.add('restricted-locked');
            document.getElementById('nav-container').classList.add('restricted-locked');
            const allNavBtns = document.querySelectorAll('.nav-button:not(.logout-unlocked)');
            allNavBtns.forEach(btn => {
                btn.onclick = (e) => {
                    if(isSystemRestricted) { triggerRestrictedPopup(); return; }
                };
            });
            document.getElementById('menuContainer').onclick = () => { if(isSystemRestricted) triggerRestrictedPopup(); };
        }

        function triggerRestrictedPopup(customMsg) {
            const warningText = customMsg || `ACCESS DENIED: OUTSIDE AUTHORIZED SHIFT HOURS\n\nEmployee: ${userProfile.name}\nShift: ${userProfile.shift}\n\nTerminal Locked.`;
            showWinMsg("ACCESS_RESTRICTED.EXE", warningText, false, null, true);
        }

        function handleSearch() {
            if (isSystemRestricted) { triggerRestrictedPopup(); return; }
            const query = document.getElementById('searchInput').value.toLowerCase();
            const dropdown = document.getElementById('searchDropdown');
            dropdown.innerHTML = '';
            if (!query) { dropdown.style.display = 'none'; return; }
            const matches = menuData.filter(i => !i.hidden && i.name.toLowerCase().includes(query));
            if (matches.length > 0) {
                dropdown.style.display = 'block';
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `<img src="${item.img}" onerror="this.src='undpfm.png'"><div><b>${item.name}</b><br>RM ${item.price.toFixed(2)}</div>`;
                    div.onclick = () => {
                        document.getElementById('categorySelect').value = "ALL";
                        activeSubFilter = "ALL";
                        renderMenu();
                        setTimeout(() => {
                            const itemsOnPage = document.querySelectorAll('.food-item b');
                            for (let b of itemsOnPage) {
                                if (b.innerText === item.name) {
                                    b.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    b.parentElement.style.outline = "3px solid #000080";
                                    setTimeout(() => b.parentElement.style.outline = "none", 2000);
                                    break;
                                }
                            }
                        }, 100);
                        dropdown.style.display = 'none';
                        document.getElementById('searchInput').value = '';
                    };
                    dropdown.appendChild(div);
                });
            } else { dropdown.style.display = 'none'; }
        }

        function setSubFilter(filter, btn) {
            if (isSystemRestricted) { triggerRestrictedPopup(); return; }
            activeSubFilter = filter;
            document.querySelectorAll('.sub-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMenu();
        }

        function switchView(view) {
            if (isSystemRestricted && view !== 'MENU') { triggerRestrictedPopup(); return; }
            const container = document.getElementById('menuContainer');
            const toolbar = document.getElementById('toolbar');
            const winTitle = document.getElementById('win-title');
            container.innerHTML = '';
            
            if(window.innerWidth <= 1024) document.getElementById('sidebar').classList.remove('open');

            if (view === 'MENU') {
                toolbar.style.display = 'block';
                winTitle.innerText = "POS_MENU_EXPLORER.EXE";
                renderMenu();
            } else {
                toolbar.style.display = 'none';
                if (view === 'TRANSACTIONS') {
                    winTitle.innerText = "TRANS_LOG_READER.EXE";
                    renderTransactions();
                } else if (view === 'INVENTORY') {
                    winTitle.innerText = "STOCK_MANAGER.EXE";
                    renderInventory();
                } else if (view === 'ITEMS') {
                    winTitle.innerText = "PRICE_DATABASE_EDITOR.EXE";
                    renderItemEditor();
                } else if (view === 'SALES') {
                    winTitle.innerText = "SALES_PERFORMANCE_DASHBOARD.EXE";
                    renderSalesDashboard();
                } else if (view === 'SETTINGS') {
                    winTitle.innerText = "SYSTEM_SETTINGS.EXE";
                    renderSettings();
                }
            }
        }

        function renderMenu() {
            const container = document.getElementById('menuContainer');
            const catSelection = document.getElementById('categorySelect').value;
            container.innerHTML = '';
            const categories = catSelection === 'ALL' ? ['FOOD', 'DRINKS', 'OTHER'] : [catSelection];

            categories.forEach(category => {
                let items = menuData.filter(i => i.cat === category && !i.hidden);
                if (activeSubFilter === "Mee") {
                    items = items.filter(i => {
                        const n = i.name.toLowerCase();
                        return n.includes("mee") || n.includes("maggi") || n.includes("kuey teow") || n.includes("bihun") || n.includes("wat tan hor");
                    });
                } else if (activeSubFilter !== "ALL") {
                    items = items.filter(i => i.name.toLowerCase().includes(activeSubFilter.toLowerCase()));
                }

                if (items.length > 0) {
                    const head = document.createElement('div');
                    head.className = 'category-header';
                    head.innerText = category;
                    container.appendChild(head);
                    const grid = document.createElement('div');
                    grid.className = 'menu-grid';
                    items.forEach(item => {
                        const div = document.createElement('div');
                        const isSoldOut = item.stock <= 0;
                        div.className = 'food-item' + (isSoldOut ? ' unavailable' : '');
                        div.innerHTML = `${item.bestSeller ? '<div class="best-seller-tag">HOT!</div>' : ''}
                                         <img src="${item.img || 'undpfm.png'}" onerror="this.src='undpfm.png'">
                                         <b>${item.name}</b><br>RM ${item.price.toFixed(2)}`;
                        if (!isSoldOut) div.onclick = (e) => { 
                            if(isSystemRestricted) { triggerRestrictedPopup(); return; }
                            handleItemClick(item); 
                        };
                        grid.appendChild(div);
                    });
                    container.appendChild(grid);
                }
            });
        }

        function renderItemEditor() {
            const container = document.getElementById('menuContainer');
            let activeItemsHtml = `<h3>DATABASE EDITOR</h3><table class="win-table"><tr><th>ITEM NAME</th><th>PRICE (RM)</th><th>ACTION</th></tr>`;
            let hiddenItemsHtml = `<h3 style="margin-top:30px; color:#666;">RECOVERY (HIDDEN ITEMS)</h3><table class="win-table" style="background:#eee; filter:grayscale(1); opacity:0.7;"><tr><th>ITEM NAME</th><th>ACTION</th></tr>`;
            
            let hasHidden = false;

            menuData.forEach((item, index) => {
                if(!item.hidden) {
                    activeItemsHtml += `<tr>
                        <td><input type="text" id="nm-${index}" value="${item.name}" style="width:100%"></td>
                        <td><input type="number" id="prc-${index}" step="0.1" value="${item.price.toFixed(2)}" style="width:60px"></td>
                        <td>
                            <button onclick="updateItemDetails(${index})">SAVE</button>
                            <button onclick="toggleItemVisibility(${index}, true)" style="background:#f00; color:#fff;">DEL</button>
                        </td>
                    </tr>`;
                } else {
                    hasHidden = true;
                    hiddenItemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>
                            <button onclick="toggleItemVisibility(${index}, false)" style="background:var(--win-blue); color:#fff;">[+] RECOVER</button>
                            <button onclick="deleteItemPermanently(${index})" style="background:#000; color:#fff;">[X] DELETE FOREVER</button>
                        </td>
                    </tr>`;
                }
            });

            let topForm = `<div class="profile-card">
                <h3>ADD NEW PRODUCT</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <input type="text" id="new-name" placeholder="Name">
                    <input type="number" id="new-price" step="0.1" placeholder="Price (RM)">
                    <select id="new-cat">
                        <option value="FOOD">FOOD</option><option value="DRINKS">DRINKS</option><option value="OTHER">OTHER</option>
                    </select>
                    <input type="text" id="new-img" placeholder="Image Name">
                    <input type="number" id="new-stock" placeholder="Initial Stock">
                    <button class="nav-button" onclick="addNewItem()" style="background:var(--win-blue); color:white; padding: 2px;">+ ADD</button>
                </div>
            </div>`;

            container.innerHTML = topForm + activeItemsHtml + "</table>" + (hasHidden ? hiddenItemsHtml + "</table>" : "");
        }

        function deleteItemPermanently(idx) {
            showWinMsg("PERMANENT DELETE", `Are you sure you want to permanently delete "${menuData[idx].name}"? This cannot be undone.`, true, () => {
                menuData.splice(idx, 1);
                saveDatabase();
                renderItemEditor();
            });
        }

        function toggleItemVisibility(idx, hide) {
            menuData[idx].hidden = hide;
            saveDatabase();
            renderItemEditor();
        }

        function renderInventory() {
            let inStock = [];
            let outStock = [];
            menuData.forEach((item, index) => {
                if(!item.hidden) {
                    let row = `<tr><td>${item.name}</td><td><input type="number" id="stk-${index}" value="${item.stock}" style="width:50px"></td>
                    <td><button onclick="updateStock(${index})">SAVE</button></td></tr>`;
                    if(item.stock > 0) inStock.push(row); else outStock.push(row);
                }
            });
            let table = `<h3>STOCK LEVELS</h3><table class="win-table"><tr><th>ITEM</th><th>STOCK</th><th>ACTION</th></tr>` 
                        + inStock.join('') 
                        + (outStock.length > 0 ? `<tr style="background:#808080; color:#fff;"><td colspan="3" style="text-align:center; font-weight:bold;">OUT OF STOCK ITEMS</td></tr>` + outStock.map(r => r.replace('<tr>', '<tr style="background:#d4d0c8; opacity:0.6;">')).join('') : '') 
                        + "</table>";
            document.getElementById('menuContainer').innerHTML = table;
        }

        function renderSalesDashboard() {
            const container = document.getElementById('menuContainer');
            const stats = calculateDaySales();
            const now = new Date();
            const dayNames = ["SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
            const currentDay = dayNames[now.getDay()];
            const currentTime = now.toLocaleTimeString();
            const currentDate = now.toLocaleDateString();
            
            let html = `<div class="profile-card" style="background:#fff;">
                <h2 style="margin:0; color:var(--win-blue);">TODAY'S PERFORMANCE</h2>
                <p style="font-size:12px; color:#555; margin-top:5px;"><b>DATE:</b> ${currentDate} | <b>DAY:</b> ${currentDay} | <b>TIME:</b> ${currentTime}</p>
                <p style="font-size:12px;"><b>Total: RM ${stats.total.toFixed(2)}</b></p>
                <hr>
                <div class="dashboard-grid">`;
            
            for (let item in stats.items) {
                html += `<div class="stat-card"><b>${item}</b><br><span style="color:#d00;">${stats.items[item]}</span></div>`;
            }

            html += `</div></div>
            <h3>PREVIOUS DAYS SUMMARY</h3>
            <div style="overflow-x:auto; white-space:nowrap; padding-bottom:10px;">`;

            if (archivedSales.length === 0) {
                html += `<div class="profile-card" style="display:inline-block; width:100%; text-align:center;">
                    <p style="font-weight:bold; color:var(--win-border-dark);">NO DATA AVAILABLE IN LOGS</p>
                </div>`;
            } else {
                archivedSales.slice().reverse().forEach((day, idx) => {
                    const dObj = new Date(day.date);
                    const dName = dayNames[dObj.getDay()] || "UNKNOWN";
                    html += `<div class="history-box" onclick="viewHistoryDetails(archivedSales.length - 1 - idx)">
                        <b>${day.date}</b><br>
                        DAY: ${dName}<br>
                        Total: RM ${day.total.toFixed(2)}<br>
                        Items: ${Object.keys(day.items).length} types
                    </div>`;
                });
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        function viewHistoryDetails(index) {
            const day = archivedSales[index];
            let itemDetails = "";
            for (let item in day.items) {
                itemDetails += `‚Ä¢ ${item}: ${day.items[item]}\n`;
            }
            showWinMsg(`SUMMARY FOR ${day.date}`, `TOTAL SALES: RM ${day.total.toFixed(2)}\n\nITEM BREAKDOWN:\n${itemDetails}`, false);
        }

        function updateItemDetails(idx) {
            menuData[idx].name = document.getElementById(`nm-${idx}`).value;
            menuData[idx].price = parseFloat(document.getElementById(`prc-${idx}`).value);
            saveDatabase();
            showWinMsg("SUCCESS", "Record updated.");
            renderItemEditor();
        }

        function addNewItem() {
            const n = document.getElementById('new-name').value;
            const p = parseFloat(document.getElementById('new-price').value);
            const c = document.getElementById('new-cat').value;
            const i = document.getElementById('new-img').value || "undpfm.png";
            const s = parseInt(document.getElementById('new-stock').value) || 0;
            if(!n || isNaN(p)) { showWinMsg("ERROR", "Invalid input data."); return; }
            menuData.push({ cat: c, name: n, img: i, price: p, stock: s, hidden: false });
            saveDatabase();
            renderItemEditor();
        }

        function updateStock(idx) {
            menuData[idx].stock = parseInt(document.getElementById(`stk-${idx}`).value);
            saveDatabase();
            renderInventory();
        }

        function renderTransactions() {
            let totalSales = transactionHistory.reduce((a, b) => a + parseFloat(b.amount), 0);
            let html = `<div class="profile-card"><h3>TOTAL HISTORY: RM ${totalSales.toFixed(2)}</h3></div>
            <table class="win-table"><tr><th>TIMESTAMP</th><th>TYPE</th><th>TOTAL</th></tr>`;
            transactionHistory.forEach(t => {
                html += `<tr><td>${t.time}</td><td>${t.type}</td><td>RM ${t.amount}</td></tr>`;
            });
            document.getElementById('menuContainer').innerHTML = html + "</table>";
        }

        function renderSettings() {
            document.getElementById('menuContainer').innerHTML = `
                <div class="profile-card">
                    <h3>SYSTEM INFO</h3>
                    <div style="font-size: 11px; max-height: 250px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #808080; margin-bottom: 10px;">
                        <b>Operating System</b>: Windows XP Legacy Hub
                    </div>
                    <hr>
                    <button class="nav-button" onclick="runDiagnostic()">RUN SYSTEM DIAGNOSTIC</button>
                    <button class="nav-button" style="background:#f00; color:#fff;" onclick="showWinMsg('WARNING', 'Reset all data?', true, ()=> { performFactoryReset(); })">FACTORY RESET SYSTEM</button>
                </div>`;
        }

        function runDiagnostic() {
            showWinMsg("DIAGNOSTIC.EXE", "Initializing hardware scan...", false);
            const modalText = document.getElementById('modalText');
            const btnContainer = document.getElementById('modalButtons');
            btnContainer.innerHTML = ''; 

            let progress = 0;
            const progressHTML = `<div class="progress-container" id="prog-bar"></div>`;
            modalText.innerHTML = "Performing integrity check... Please wait.\n" + progressHTML;
            
            const bar = document.getElementById('prog-bar');
            const interval = setInterval(() => {
                if (progress < 10) {
                    const seg = document.createElement('div');
                    seg.className = 'progress-segment';
                    bar.appendChild(seg);
                    progress++;
                } else {
                    clearInterval(interval);
                    modalText.innerHTML = "DIAGNOSTIC COMPLETE\n\nDatabase integrity check: 100% OK\nAll hardware components responding.";
                    const ok = document.createElement('button'); 
                    ok.className='nav-button'; ok.innerText="OK"; 
                    ok.onclick=()=>document.getElementById('customModal').style.display='none';
                    btnContainer.appendChild(ok);
                }
            }, 500); 
        }

        function performFactoryReset() {
            const currentUser = localStorage.getItem("loggedInUser");
            localStorage.clear();
            if(currentUser) localStorage.setItem("loggedInUser", currentUser);
            menuData = [...defaultMenuData];
            cart = [];
            transactionHistory = [];
            archivedSales = [];
            saveDatabase();
            initMenu();
            showWinMsg("SYSTEM RESET", "Local database has been wiped. Returning to main terminal.");
        }

        function handleItemClick(item) {
            if (item.cat === "DRINKS" && item.hasTemp) {
                pendingItem = item;
                document.getElementById('modalItemName').innerText = item.name;
                document.getElementById('drinkModalImg').src = item.img;
                document.getElementById('drinkModal').style.display = 'flex';
            } else {
                let p = item.price; let n = item.name;
                if (item.cat === "DRINKS" && selectedServiceStr === "TAKE AWAY") { p += 0.5; n += " (T/A)"; }
                addToCart(n, p, item);
            }
        }

        function confirmDrink(temp) {
            let p = pendingItem.price;
            let n = pendingItem.name + ` [${temp}]`;
            if (temp === 'COLD') p += 0.5;
            if (selectedServiceStr === "TAKE AWAY") { p += 0.5; n += " (T/A)"; }
            addToCart(n, p, pendingItem);
            closeDrinkModal();
        }

        function addToCart(name, price, origin) {
            cart.push({ name: name, price: price, img: origin.img });
            origin.stock--;
            saveDatabase();
            updateCartUI();
        }

        function removeFromCart(idx) {
            if(isSystemRestricted) { triggerRestrictedPopup(); return; }
            let itemName = cart[idx].name.split(" [")[0].replace(" (T/A)", "");
            let origin = menuData.find(m => m.name === itemName);
            if(origin) origin.stock++;
            cart.splice(idx, 1);
            saveDatabase();
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-items');
            list.innerHTML = '';
            let total = 0;
            cart.forEach((item, index) => {
                total += item.price;
                list.innerHTML += `<div class="cart-row"><span>${item.name}</span><span>RM ${item.price.toFixed(2)} <button onclick="removeFromCart(${index})" style="background:#f00; color:#fff; border:1px solid #000; cursor:pointer;">X</button></span></div>`;
            });
            document.getElementById('cart-total').innerText = total.toFixed(2);
        }

        function selectService(type) {
            if(type === 'DINE IN') {
                localStorage.setItem("serviceType", "DINE IN");
                window.location.href = 'table.html';
            } else {
                selectedServiceStr = type;
                document.getElementById('serviceOverlay').style.display = 'none';
                document.getElementById('service-type').innerText = `TYPE: ${type}`;
                localStorage.setItem("serviceType", type);
            }
        }

        function proceedToPayment() {
            if (isSystemRestricted) { triggerRestrictedPopup(); return; }
            if (cart.length === 0) { showWinMsg("ALERT", "Cart is empty!"); return; }
            localStorage.setItem("currentOrder", JSON.stringify(cart));
            localStorage.setItem("totalAmount", document.getElementById('cart-total').innerText);
            localStorage.setItem("serviceType", selectedServiceStr);
            window.location.href = "payment.html";
        }

        function triggerLogout() {
            showWinMsg("LOGOUT", "Exit terminal?", true, () => {
                localStorage.removeItem("loggedInUser");
                window.location.href = "index.html";
            });
        }
        
        function triggerReboot() {
            showWinMsg("SYSTEM REBOOT", "Are you sure you want to reboot the terminal?\nUnsaved session data may be lost.", true, () => {
                window.location.href = "reboot.html";
            });
        }

        function showWinMsg(title, text, confirmMode = false, onConfirm = null, restrictionMode = false) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalText').innerText = text;
            const btnContainer = document.getElementById('modalButtons');
            btnContainer.innerHTML = '';
            
            if (restrictionMode) {
                const closeBtn = document.createElement('button'); 
                closeBtn.className='nav-button'; closeBtn.innerText="CLOSE"; 
                closeBtn.onclick=()=> { modal.style.display='none'; };
                
                const contactBtn = document.createElement('button'); 
                contactBtn.className='nav-button'; contactBtn.innerText="CONTACT ADMIN"; 
                contactBtn.style.background = "#000080"; contactBtn.style.color = "white";
                contactBtn.onclick=()=> { window.location.href = "contact.html"; };
                
                btnContainer.appendChild(closeBtn);
                btnContainer.appendChild(contactBtn);
            } else if (confirmMode) {
                const y = document.createElement('button'); y.className='nav-button'; y.innerText="YES"; y.onclick=()=>{modal.style.display='none'; onConfirm();};
                const n = document.createElement('button'); n.className='nav-button'; n.innerText="NO"; n.onclick=()=>modal.style.display='none';
                btnContainer.appendChild(y); btnContainer.appendChild(n);
            } else {
                const ok = document.createElement('button'); ok.className='nav-button'; ok.innerText="OK"; ok.onclick=()=>modal.style.display='none';
                btnContainer.appendChild(ok);
            }
            modal.style.display = 'flex';
        }

        function closeDrinkModal() { document.getElementById('drinkModal').style.display = 'none'; pendingItem = null; }
        function updateClock() { 
            const now = new Date();
            document.getElementById('top-clock').innerText = now.toLocaleTimeString(); 
            document.getElementById('status-date').innerText = "DATE: " + now.toLocaleDateString();
            setTimeout(updateClock, 1000); 
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchDropdown').style.display = 'none';
            }
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('hamburger-toggle');
            if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });
    </script>
</body>
</html>